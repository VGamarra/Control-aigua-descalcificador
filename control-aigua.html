<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Duresa de l'Aigua</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Control Aigua">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-gray {
            background: #6c757d;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-weight: 600;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .monthly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .monthly-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .regeneration-history {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíß Control de Duresa de l'Aigua</h1>
            <p>Seguiment i an√†lisi avan√ßat del sistema de tractament d'aigua</p>
        </div>
        
        <div class="card">
            <h2>Nou Registre</h2>
            <div class="input-group">
                <label for="hardness">Duresa de l'aigua (¬∞f):</label>
                <input type="number" id="hardness" step="0.1" placeholder="Ex: 25.5">
            </div>
            <div class="input-group">
                <label for="liters">Litres pendents per regeneraci√≥:</label>
                <input type="number" id="liters" step="1" placeholder="Ex: 1200">
            </div>
            <div class="input-group">
                <label for="recordDate">Data i hora (opcional - deixa buit per ara):</label>
                <input type="datetime-local" id="recordDate">
            </div>
            <button class="btn" onclick="addRecord()">Afegir Registre</button>
            <button class="btn btn-secondary" onclick="addRegeneration()">Regeneraci√≥ Realitzada</button>
            <button class="btn btn-gray" onclick="clearDate()">üóëÔ∏è Netejar Data</button>
        </div>

        <div class="card">
            <h2>üíæ Gesti√≥ de Dades</h2>
            <p style="margin-bottom: 15px; color: #666;">Sincronitza les dades amb el teu fitxer Excel principal i crea c√≤pies de seguretat autom√†tiques.</p>
            
            <!-- Configuraci√≥ de ruta -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                <h4 style="margin: 0 0 10px 0;">‚öôÔ∏è Configuraci√≥ de Desc√†rregues</h4>
                <div style="margin-bottom: 10px;">
                    <label for="downloadPath" style="font-weight: normal; margin-bottom: 5px; display: block;">
                        üìÅ Ruta recomanada per guardar els fitxers:
                    </label>
                    <input type="text" id="downloadPath" placeholder="Ex: C:\Users\ElTeuNom\Google Drive\Control Aigua" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-gray" onclick="setGoogleDrivePath()">üìÇ Google Drive</button>
                    <button class="btn btn-gray" onclick="setOneDrivePath()">üìÇ OneDrive</button>
                    <button class="btn btn-gray" onclick="setCustomPath()">üìÇ Ruta Personalitzada</button>
                </div>
                <small style="color: #666; display: block; margin-top: 8px;">
                    üí° <strong>Consell:</strong> Configura el teu navegador per descarregar sempre a aquesta carpeta autom√†ticament.
                </small>
            </div>
            
            <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0;">üìã Com configurar desc√†rregues autom√†tiques:</h4>
                <div id="browserInstructions">
                    <p style="margin: 5px 0;"><strong>Google Chrome:</strong></p>
                    <ol style="margin: 0 0 10px 20px; color: #555; font-size: 14px;">
                        <li>Configuraci√≥ ‚Üí Desc√†rregues</li>
                        <li>Activa "Pregunta on guardar cada fitxer abans de descarregar-lo"</li>
                        <li>O configura la ubicaci√≥ per defecte</li>
                    </ol>
                    <p style="margin: 5px 0;"><strong>Firefox:</strong></p>
                    <ol style="margin: 0 0 10px 20px; color: #555; font-size: 14px;">
                        <li>Configuraci√≥ ‚Üí General ‚Üí Fitxers i aplicacions</li>
                        <li>Selecciona "Pregunta sempre on guardar els fitxers"</li>
                    </ol>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <button class="btn" onclick="exportMainExcel()">üìä Actualitzar Excel Principal</button>
                <button class="btn btn-secondary" onclick="exportBackupExcel()">üóÑÔ∏è Crear C√≤pia de Seguretat</button>
                <button class="btn btn-gray" onclick="document.getElementById('fileInput').click()">üìÅ Importar Excel</button>
            </div>
            
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(event)">
            
            <!-- Instruccions de sincronitzaci√≥ -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <h4 style="margin: 0 0 10px 0;">‚òÅÔ∏è Sincronitzaci√≥ amb el n√∫vol:</h4>
                <div id="syncInstructions"></div>
            </div>
            
            <!-- Auto-save indicator -->
            <div id="autoSaveStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="autoSaveIcon">üíæ</span>
                    <div>
                        <div id="autoSaveText" style="font-weight: 600;"></div>
                        <div id="autoSavePath" style="font-size: 12px; opacity: 0.8; margin-top: 2px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Estad√≠stiques Generals</h2>
            <div id="alertContainer"></div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgDailyConsumption">-</div>
                    <div class="stat-label">Consum mitj√† diari (L)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgHardness">-</div>
                    <div class="stat-label">Duresa mitjana (¬∞f)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRecords">-</div>
                    <div class="stat-label">Registres totals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgTimeBetweenRegen">-</div>
                    <div class="stat-label">Dies mitjans entre regeneracions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRegenerations">-</div>
                    <div class="stat-label">Regeneracions totals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastRegeneration">-</div>
                    <div class="stat-label">Dies des de l'√∫ltima regeneraci√≥</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>An√†lisi Mensual</h2>
            <div class="month-selector">
                <select id="monthSelect" onchange="updateMonthlyStats()">
                    <option value="">Tots els mesos</option>
                </select>
                <select id="yearSelect" onchange="updateMonthlyStats()">
                    <option value="">Tots els anys</option>
                </select>
            </div>
            <div class="monthly-stats" id="monthlyStats"></div>
        </div>

        <div class="card">
            <h2>Gr√†fics i Tend√®ncies</h2>
            <div class="charts-grid">
                <div class="card">
                    <h3>Evoluci√≥ de la Duresa</h3>
                    <div class="chart-container">
                        <canvas id="hardnessChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Consum Diari d'Aigua</h3>
                    <div class="chart-container">
                        <canvas id="consumptionChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Litres Pendents</h3>
                    <div class="chart-container">
                        <canvas id="litersChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Consum Mensual</h3>
                    <div class="chart-container">
                        <canvas id="monthlyConsumptionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Historial de Regeneracions</h2>
            <div id="regenerationHistory"></div>
        </div>
        
        <div class="card">
            <h2>Historial de Registres</h2>
            <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Esborrar Tot</button>
            <table>
                <thead>
                    <tr>
                        <th>Data i Hora</th>
                        <th>Duresa (¬∞f)</th>
                        <th>Litres Pendents</th>
                        <th>Consum (L)</th>
                        <th>Accions</th>
                    </tr>
                </thead>
                <tbody id="recordsTable">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('waterRecords') || '[]');
        let regenerations = JSON.parse(localStorage.getItem('regenerations') || '[]');
        let charts = {};

        function saveData() {
            localStorage.setItem('waterRecords', JSON.stringify(records));
            localStorage.setItem('regenerations', JSON.stringify(regenerations));
        }

        function addRecord() {
            console.log('Afegint registre...');
            
            const hardness = parseFloat(document.getElementById('hardness').value);
            const liters = parseInt(document.getElementById('liters').value);
            const customDate = document.getElementById('recordDate').value;
            
            if (isNaN(hardness) || isNaN(liters)) {
                alert('Si us plau, introdueix valors v√†lids per duresa i litres');
                return;
            }
            
            const recordDateTime = customDate ? new Date(customDate) : new Date();
            
            const record = {
                id: Date.now(),
                datetime: recordDateTime.toISOString(),
                hardness: hardness,
                liters: liters,
                isRegeneration: false
            };
            
            records.push(record);
            records.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            saveData();

            // Enviar a Google Sheets
            fetch("https://script.google.com/macros/s/AKfycbxKaNOH6oCYR-HKvupKEPdL7RQRMDpXwX-apj1uCdd21i_SuDG8nWUNBapDQWPidaZftw/exec", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    datetime: record.datetime,
                    hardness: record.hardness,
                    liters: record.liters,
                    isRegeneration: false
                })
            })
            .then(res => res.text())
            .then(res => console.log("Google Sheets:", res))
            .catch(err => console.error("Error enviant a Sheets:", err));
            updateDisplay();
            
            // Auto-save a Excel si hi ha m√©s de 3 registres
            if (records.length > 3) {
                setTimeout(() => {
                    exportMainExcel();
                }, 1000);
            }
            
            // Netejar camps
            document.getElementById('hardness').value = '';
            document.getElementById('liters').value = '';
            document.getElementById('recordDate').value = '';
            
            console.log('Registre afegit correctament');
        }

        function addRegeneration() {
            console.log('Afegint regeneraci√≥...');
            
            const customDate = document.getElementById('recordDate').value;
            const recordDateTime = customDate ? new Date(customDate) : new Date();
            
            const regeneration = {
                id: Date.now(),
                datetime: recordDateTime.toISOString(),
                hardness: 0,
                liters: 0,
                isRegeneration: true
            };
            
            records.push(regeneration);
            regenerations.push(recordDateTime.toISOString());
            
            records.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            regenerations.sort((a, b) => new Date(b) - new Date(a));
            
            saveData();

            // Enviar a Google Sheets
            fetch("https://script.google.com/macros/s/AKfycbxKaNOH6oCYR-HKvupKEPdL7RQRMDpXwX-apj1uCdd21i_SuDG8nWUNBapDQWPidaZftw/exec", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    datetime: regeneration.datetime,
                    hardness: 0,
                    liters: 0,
                    isRegeneration: true
                })
            })
            .then(res => res.text())
            .then(res => console.log("Google Sheets:", res))
            .catch(err => console.error("Error enviant a Sheets:", err));
            updateDisplay();
            
            // Auto-save despr√©s de regeneraci√≥
            setTimeout(() => {
                exportMainExcel();
            }, 1000);
            
            document.getElementById('recordDate').value = '';
            
            console.log('Regeneraci√≥ afegida correctament');
        }

        function clearDate() {
            document.getElementById('recordDate').value = '';
        }

        function deleteRecord(id) {
            if (confirm('Est√†s segur que vols eliminar aquest registre?')) {
                const record = records.find(r => r.id === id);
                if (record && record.isRegeneration) {
                    regenerations = regenerations.filter(r => r !== record.datetime);
                }
                records = records.filter(record => record.id !== id);
                saveData();
                updateDisplay();
            }
        }

        function clearAllData() {
            if (confirm('Est√†s segur que vols esborrar totes les dades?')) {
                records = [];
                regenerations = [];
                saveData();
                updateDisplay();
            }
        }

        function calculateConsumption(currentRecord, previousRecord) {
            if (!previousRecord || previousRecord.isRegeneration) return 0;
            return Math.max(0, previousRecord.liters - currentRecord.liters);
        }

        function getTimeBetweenRegenerations() {
            if (regenerations.length < 2) return [];
            
            const times = [];
            for (let i = 0; i < regenerations.length - 1; i++) {
                const diff = new Date(regenerations[i]) - new Date(regenerations[i + 1]);
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                times.push(days);
            }
            return times;
        }

        function getDaysSinceLastRegeneration() {
            if (regenerations.length === 0) return null;
            const lastRegen = new Date(regenerations[0]);
            const now = new Date();
            return Math.floor((now - lastRegen) / (1000 * 60 * 60 * 24));
        }

        function getMonthlyData() {
            const monthlyData = {};
            
            records.filter(r => !r.isRegeneration).forEach((record, index) => {
                const date = new Date(record.datetime);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        hardnessValues: [],
                        consumptions: [],
                        totalConsumption: 0,
                        recordCount: 0,
                        year: date.getFullYear(),
                        month: date.getMonth() + 1
                    };
                }
                
                monthlyData[monthKey].hardnessValues.push(record.hardness);
                monthlyData[monthKey].recordCount++;
                
                const previousRecord = records[index + 1];
                const consumption = calculateConsumption(record, previousRecord);
                if (consumption > 0) {
                    monthlyData[monthKey].consumptions.push(consumption);
                    monthlyData[monthKey].totalConsumption += consumption;
                }
            });
            
            // Calcular mitjanes
            Object.keys(monthlyData).forEach(key => {
                const data = monthlyData[key];
                data.avgHardness = data.hardnessValues.length > 0 ? 
                    data.hardnessValues.reduce((a, b) => a + b, 0) / data.hardnessValues.length : 0;
                data.avgDailyConsumption = data.consumptions.length > 0 ? 
                    data.totalConsumption / data.consumptions.length : 0;
            });
            
            return monthlyData;
        }

        function updateMonthSelectors() {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            const months = new Set();
            const years = new Set();
            
            records.forEach(record => {
                const date = new Date(record.datetime);
                months.add(date.getMonth() + 1);
                years.add(date.getFullYear());
            });
            
            // Actualitzar selector de mesos
            monthSelect.innerHTML = '<option value="">Tots els mesos</option>';
            Array.from(months).sort((a, b) => a - b).forEach(month => {
                const monthName = new Date(2000, month - 1, 1).toLocaleString('ca-ES', { month: 'long' });
                monthSelect.innerHTML += `<option value="${month}">${monthName}</option>`;
            });
            
            // Actualitzar selector d'anys
            yearSelect.innerHTML = '<option value="">Tots els anys</option>';
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }

        function updateMonthlyStats() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const selectedYear = document.getElementById('yearSelect').value;
            const monthlyData = getMonthlyData();
            const container = document.getElementById('monthlyStats');
            
            let filteredData = Object.entries(monthlyData);
            
            // Filtrar per mes i any si estan seleccionats
            if (selectedMonth || selectedYear) {
                filteredData = filteredData.filter(([key, data]) => {
                    return (!selectedMonth || data.month == selectedMonth) &&
                           (!selectedYear || data.year == selectedYear);
                });
            }
            
            container.innerHTML = '';
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p>No hi ha dades per als filtres seleccionats.</p>';
                return;
            }
            
            filteredData.forEach(([key, data]) => {
                const monthName = new Date(data.year, data.month - 1, 1).toLocaleString('ca-ES', { month: 'long', year: 'numeric' });
                
                container.innerHTML += `
                    <div class="monthly-stat-card">
                        <h4>${monthName}</h4>
                        <div class="stat-value">${data.avgHardness.toFixed(1)} ¬∞f</div>
                        <div class="stat-label">Duresa mitjana</div>
                        <hr style="margin: 10px 0; opacity: 0.3;">
                        <div class="stat-value">${data.avgDailyConsumption.toFixed(1)} L</div>
                        <div class="stat-label">Consum mitj√† diari</div>
                        <hr style="margin: 10px 0; opacity: 0.3;">
                        <div class="stat-value">${data.totalConsumption} L</div>
                        <div class="stat-label">Consum total</div>
                    </div>
                `;
            });
        }

        function updateRegenerationHistory() {
            const container = document.getElementById('regenerationHistory');
            
            if (regenerations.length === 0) {
                container.innerHTML = '<p>No hi ha regeneracions registrades.</p>';
                return;
            }
            
            const times = getTimeBetweenRegenerations();
            let html = '';
            
            regenerations.forEach((regen, index) => {
                const date = new Date(regen).toLocaleString('ca-ES');
                const daysBetween = times[index] ? ` (${times[index]} dies despr√©s de l'anterior)` : '';
                
                html += `
                    <div class="regeneration-history">
                        <strong>üîÑ Regeneraci√≥ ${index + 1}</strong><br>
                        üìÖ ${date}${daysBetween}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function createCharts() {
            const nonRegenRecords = records.filter(r => !r.isRegeneration).reverse();
            
            // Gr√†fic de duresa
            const hardnessCtx = document.getElementById('hardnessChart');
            if (charts.hardness) charts.hardness.destroy();
            
            charts.hardness = new Chart(hardnessCtx, {
                type: 'line',
                data: {
                    labels: nonRegenRecords.map(r => new Date(r.datetime).toLocaleDateString('ca-ES')),
                    datasets: [{
                        label: 'Duresa (¬∞f)',
                        data: nonRegenRecords.map(r => r.hardness),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,